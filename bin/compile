#!/usr/bin/env bash

# set -e            # fail fast
# set -o pipefail   # don't ignore exit codes when piping output
# set -x          # enable debugging

# Configure directories
build_dir=$1
cache_dir=$2
env_dir=$3

bp_dir=$(cd $(dirname $0); cd ..; pwd)

source $bp_dir/bin/common.sh

export LDFLAGS=-L$build_dir/vendor/lib
export LD_LIBRARY_PATH=$build_dir/vendor/lib

download () {
	status "Downloading and installing ZBAR"
  zbar_url="http://iweb.dl.sourceforge.net/project/zbar/zbar/0.10/zbar-0.10.tar.bz2"
  curl $zbar_url -s -o - | tar jxf - -C $build_dir
}

install () {
	if [ -f $build_dir/vendor/zbar ]; then
	  exit 0
	else
		download
  	mkdir -p $build_dir/vendor/bin
	  mv $build_dir/zbar-0.10 $build_dir/vendor/zbar
		cd $build_dir/vendor/zbar
	  LDFLAGS=-s ./configure --disable-video --without-gtk --without-qt --prefix=$build_dir/vendor  
	  make  >/dev/null 2>&1
	  make install  >/dev/null 2>&1
	fi
	set_config_vars
}

set_config_vars () {
	PROFILE_PATH="$bp_dir/.profile.d/zbar.sh"
	mkdir -p $(dirname $PROFILE_PATH)
	echo 'export PATH="/app/vendor/bin:$PATH";' >> $PROFILE_PATH
	echo 'export LD_LIBRARY_PATH="/app/vendor/lib";' >> $PROFILE_PATH
	
}

install

exit 0